<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Іменинники по тижнях</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    h1, h3 {
      text-align: center;
      margin-bottom: 10px;
      color: #222;
    }
    h1 { font-size: 2em; }
    h3 { font-size: 1.1em; margin-bottom: 40px; color: #555; }

    .week-block {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .week-prev { background-color: #eef6ff; }
    .week-next { background-color: #fff8e1; }
    .week-block h2 {
      margin: 0 0 10px;
      font-size: 1.2em;
      color: #0077cc;
    }
    ul { list-style: none; padding-left: 0; margin: 0; }
    li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    li:last-child { border-bottom: none; }
    .person-info {
      display: flex;
      flex-direction: column;
    }
    .person-name {
      font-weight: bold;
      font-size: 1.1em;
    }
    .person-meta {
      font-size: 0.9em;
      color: #555;
    }
    img {
      object-fit: cover;
      cursor: pointer;
    }

    @media (min-width: 600px) {
      .person-info {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .person-meta {
        text-align: right;
        min-width: 200px;
      }
    }

    /* Модальное окно */
    #modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <h1>Іменинники по тижнях</h1>
  <h3>Розширена версія (церква ЄХБ "Дім Євангелія", м.Суми)</h3>
  <div id="loading">Завантаження даних...</div>
  <div id="error"></div>
  <div id="list"></div>

  <!-- Модалка -->
  <div id="modal" onclick="this.style.display='none'">
    <img id="modal-img" src="" alt="Фото" />
  </div>

  <script>
    async function loadData() {
      try {
        hideAll();
        document.getElementById('loading').style.display = 'block';
        const res = await fetch('https://dl.dropboxusercontent.com/scl/fi/o2je5n0ib8v4zsjeq12ix/photo-database.json?rlkey=gm6ofx2gq2g8u8te976gwqs7d&dl=1');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        processData(json);
      } catch (e) {
        showError(e.message);
      }
    }

    function hideAll() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('list').innerHTML = '';
    }

    function showError(msg) {
      hideAll();
      const err = document.getElementById('error');
      err.textContent = 'Помилка завантаження: ' + msg;
      err.style.display = 'block';
    }

    function calculateAge(birthDate) {
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    function getWeeksExtended(year, month) {
      const weeks = [];
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      let start = new Date(firstDay);
      start.setDate(start.getDate() - (start.getDay() === 0 ? 6 : start.getDay() - 1));

      const prevWeekStart = new Date(start);
      prevWeekStart.setDate(prevWeekStart.getDate() - 7);
      const prevWeekEnd = new Date(prevWeekStart);
      prevWeekEnd.setDate(prevWeekEnd.getDate() + 6);
      weeks.push({ start: prevWeekStart, end: prevWeekEnd, items: [], type: 'prev' });

      while (start <= lastDay || start.getDay() !== 1) {
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        weeks.push({ start: new Date(start), end, items: [], type: 'current' });
        start.setDate(start.getDate() + 7);
      }

      const nextWeekStart = new Date(start);
      const nextWeekEnd = new Date(nextWeekStart);
      nextWeekEnd.setDate(nextWeekEnd.getDate() + 6);
      weeks.push({ start: nextWeekStart, end: nextWeekEnd, items: [], type: 'next' });

      return weeks;
    }

    function formatDateRange(start, end) {
      const locale = 'uk-UA';
      const options = { day: 'numeric', month: 'long' };
      const startStr = start.toLocaleDateString(locale, options);
      const endStr = end.toLocaleDateString(locale, options);
      return `${startStr} – ${endStr}`;
    }

    function openModal(src) {
      const modal = document.getElementById('modal');
      const img = document.getElementById('modal-img');
      img.src = src;
      modal.style.display = 'flex';
    }

    function processData(data) {
      hideAll();
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();

      const weeks = getWeeksExtended(year, month);

      data.entries.forEach(person => {
        const birthDate = new Date(person.birthdate);
        const thisYearBday = new Date(year, birthDate.getMonth(), birthDate.getDate());
        const fullDate = thisYearBday.toLocaleDateString('uk-UA');
        const age = calculateAge(birthDate);

        for (let week of weeks) {
          if (thisYearBday >= week.start && thisYearBday <= week.end) {
            week.items.push({
              name: person.lastname,
              fullDate,
              birthYear: birthDate.getFullYear(),
              age,
              phone: person.phone || '',
              id: person.id || ''
            });
            break;
          }
        }
      });

      const container = document.getElementById('list');
      let currentWeekIndex = 1;

      weeks.forEach(week => {
        if (week.items.length === 0) return;

        const block = document.createElement('div');
        block.className = 'week-block';
        if (week.type === 'prev') block.classList.add('week-prev');
        if (week.type === 'next') block.classList.add('week-next');

        const title = document.createElement('h2');
        if (week.type === 'prev') {
          title.textContent = `Попередній тиждень (${formatDateRange(week.start, week.end)})`;
        } else if (week.type === 'next') {
          title.textContent = `Наступний тиждень (${formatDateRange(week.start, week.end)})`;
        } else {
          title.textContent = `Тиждень ${currentWeekIndex++} (${formatDateRange(week.start, week.end)})`;
        }
        block.appendChild(title);

        const ul = document.createElement('ul');
        week.items.forEach(p => {
          const li = document.createElement('li');
          const info = document.createElement('div');
          info.className = 'person-info';

          const nameBlock = document.createElement('div');
          nameBlock.className = 'person-name';

          const img = document.createElement('img');
          img.src = `https://drive.google.com/thumbnail?id=${p.id}&sz=w200`;
          img.alt = p.name;
          img.style.width = '50px';
          img.style.height = '50px';
          img.style.borderRadius = '50%';
          img.style.marginRight = '10px';
          img.onerror = () => {
            img.src = 'https://raw.githubusercontent.com/christian-word/slider/main/4054617.png';
          };
          img.onclick = () => openModal(`https://drive.google.com/thumbnail?id=${p.id}&sz=w1000`);


          const nameText = document.createElement('span');
          nameText.textContent = p.name;

          const nameContainer = document.createElement('div');
          nameContainer.style.display = 'flex';
          nameContainer.style.alignItems = 'center';
          nameContainer.appendChild(img);
          nameContainer.appendChild(nameText);

          nameBlock.appendChild(nameContainer);

          const meta = document.createElement('div');
          meta.className = 'person-meta';
          meta.innerHTML = `
            Дата: ${p.fullDate}<br>
            Рік народження: ${p.birthYear}<br>
            Вік: ${p.age} років${p.phone ? `<br>Тел.: ${p.phone}` : ''}
          `;

          info.appendChild(nameBlock);
          info.appendChild(meta);
          li.appendChild(info);
          ul.appendChild(li);
        });

        block.appendChild(ul);
        container.appendChild(block);
      });
    }

    loadData();
  </script>
</body>
</html>

