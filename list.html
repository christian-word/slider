
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Именинники по неделям</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 2em;
      color: #222;
    }
    .week-block {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .week-block h2 {
      margin: 0 0 10px;
      font-size: 1.2em;
      color: #0077cc;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    li:last-child {
      border-bottom: none;
    }
    .person-info {
      display: flex;
      flex-direction: column;
    }
    .person-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    .person-meta {
      font-size: 0.9em;
      color: #555;
    }
    img {
      object-fit: cover;
    }
    @media (min-width: 600px) {
      .person-info {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      .person-meta {
        text-align: right;
        min-width: 200px;
      }
    }
  </style>
</head>
<body>
  <h1>Именинники по неделям</h1>
  <div id="loading">Загрузка данных...</div>
  <div id="error"></div>
  <div id="list"></div>

  <script>
    async function loadData() {
      try {
        hideAll();
        document.getElementById('loading').style.display = 'block';
        const res = await fetch('https://dl.dropboxusercontent.com/scl/fi/o2je5n0ib8v4zsjeq12ix/photo-database.json?rlkey=gm6ofx2gq2g8u8te976gwqs7d&dl=1');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        processData(json);
      } catch (e) {
        showError(e.message);
      }
    }

    function hideAll() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('list').innerHTML = '';
    }

    function showError(msg) {
      hideAll();
      const err = document.getElementById('error');
      err.textContent = 'Ошибка загрузки: ' + msg;
      err.style.display = 'block';
    }

    function calculateAge(birthDate) {
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    function getWeeksOfMonth(year, month) {
      const weeks = [];
      const firstDay = new Date(year, month, 1);
      let start = new Date(firstDay);
      start.setDate(start.getDate() - (start.getDay() === 0 ? 6 : start.getDay() - 1)); // к понедельнику

      while (start.getMonth() <= month) {
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        weeks.push({ start: new Date(start), end: new Date(end), items: [] });
        start.setDate(start.getDate() + 7);
        if (start.getMonth() > month && start.getDate() > 7) break;
      }
      return weeks;
    }

    function processData(data) {
      hideAll();
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const monthName = now.toLocaleDateString('ru-RU', { month: 'long' });

      const weeks = getWeeksOfMonth(year, month);

      data.entries.forEach(person => {
        const birthDate = new Date(person.birthdate);
        if (birthDate.getMonth() !== month) return;

        const thisYearBday = new Date(year, month, birthDate.getDate());
        const fullDate = thisYearBday.toLocaleDateString('ru-RU');
        const age = calculateAge(birthDate);

        for (let week of weeks) {
          if (thisYearBday >= week.start && thisYearBday <= week.end) {
            week.items.push({
              name: person.lastname,
              fullDate,
              birthYear: birthDate.getFullYear(),
              age,
              phone: person.phone || '',
              id: person.id || ''
            });
            break;
          }
        }
      });

      const container = document.getElementById('list');
      weeks.forEach((week, index) => {
        if (week.items.length === 0) return;

        const start = week.start.getDate();
        const end = week.end.getDate();
        const h = document.createElement('div');
        h.className = 'week-block';

        const title = document.createElement('h2');
        title.textContent = `Неделя ${index + 1} (${start}–${end} ${monthName})`;
        h.appendChild(title);

        const ul = document.createElement('ul');
        week.items.forEach(p => {
          const li = document.createElement('li');
          const info = document.createElement('div');
          info.className = 'person-info';

          const nameBlock = document.createElement('div');
          nameBlock.className = 'person-name';

          const img = document.createElement('img');
          img.src = `https://drive.google.com/thumbnail?id=${p.id}&sz=w200`;
          img.alt = p.name;
          img.style.width = '50px';
          img.style.height = '50px';
          img.style.borderRadius = '50%';
          img.style.marginRight = '10px';
          img.onerror = () => {
            img.src = 'https://raw.githubusercontent.com/christian-word/slider/main/4054617.png';
          };

          const nameText = document.createElement('span');
          nameText.textContent = p.name;

          const nameContainer = document.createElement('div');
          nameContainer.style.display = 'flex';
          nameContainer.style.alignItems = 'center';
          nameContainer.appendChild(img);
          nameContainer.appendChild(nameText);

          nameBlock.appendChild(nameContainer);

          const meta = document.createElement('div');
          meta.className = 'person-meta';
          meta.innerHTML = `
            Дата: ${p.fullDate}<br>
            Год рождения: ${p.birthYear}<br>
            Возраст: ${p.age} лет${p.phone ? `<br>Тел: ${p.phone}` : ''}
          `;

          info.appendChild(nameBlock);
          info.appendChild(meta);
          li.appendChild(info);
          ul.appendChild(li);
        });

        h.appendChild(ul);
        container.appendChild(h);
      });
    }

    loadData();
  </script>
</body>
</html>
